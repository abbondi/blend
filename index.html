<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>BLEND</title>
<link href='http://fonts.googleapis.com/css?family=Ropa+Sans:400,400italic' rel='stylesheet' type='text/css'>
<link href="css/style.css" rel="stylesheet" type="text/css">
<style type="text/css">
#monitorTxt { 
position: absolute;
color:#fff;
padding:6px;

}
.content {
	position:relative;
	top:0;
	left:0;
	width:100%;
	height:auto;
	border:none;	
}

.button {
	position:relative;
	top:0;
	left:0;
	width:96%;
	height:16px;
	border:1px solid#999;
	margin:5px auto;
	padding: 8px 0;
	text-align:center;	
	font-family: 'Ropa Sans', sans-serif;
	font-size:16px;	
	line-height:16px;
	color:#3399cc;
	cursor:pointer;
	
border-radius:4px;
-webkit-border-radius:4px;		
	
}

.btnQR {
	height:250px; padding:16px 0;	
}
</style>
	<script type="text/javascript" src="js/jquery-1.7.1.js"></script>
	<script>
			
			/* VARIABILI */					
			var  autoid 			= "0";
			var  email  			= "";
			var  name  				= "";
			var  birthday  			= "";
			var  tessera  			= "";
			var  amministratore  	= "";
			var  appPath 			= "http://www.zinilombardia2013.it/apps/blend/"; //sessione.php?callback=?";
			var	 appName 			= "blend";						
			var  contatore			= 0;
			
			/* FUNZIONI JS */
			function raggiungi(destinazione) {
				window.location.href = destinazione;
			}
			
			function mostraVIPCard() {
				window.location.href = appPath + 'vipcard.php?ID=' + autoid + '-' + tessera;
			}
			
			function dettaglioCliente() {
				$('#clienteBtn').html(email + ', ' + amministratore);
				alert(
				'autoid = ' + autoid + 
				'\nemail =' + email + 
				'\nname =' + name + 
				'\nbirthday =' + birthday + 
				'\ntessera =' + tessera + '\namministratore =' + amministratore
				);
					
			}
			
			// oggetto per memorizzare localmente i dati di sessione;
			function sessioneObj(var1, var2, var3, var4, var5, var6) {
				
				this.autoid 		= var1;
				this.email 			= var2;
				this.name 			= var3;
				this.birthday 		= var4;
				this.tessera 		= var5;
				this.amministratore = var6;
	            this.toString = toString;
            }
			
			
            function toString() {
                return "autoid=" + this.autoid +
                       " email=" + this.email + 
					   " name=" + this.name +
					   " birthday=" + this.birthday + 
                       " tessera=" + this.tessera + 
                       " amministratore=" + this.amministratore;
            }
            
            function setIt(s1, s2, s3, s4, s5, s6) {
                var profiloObj = new sessioneObj(s1, s2, s3, s4, s5, s6);
                localStorage.setItem("profilo_key", JSON.stringify(profiloObj));
				
				
				
                //$('#monitorTxt').append("<br>Dati in remoto trovati e registarti in locale.");
            }
			
			
			
			function controllaLogin() {
				
				$.getJSON(appPath + 'sessione.php?callback=?','app=' + appName,function(res){
					
					autoid 			= res.autoid;
					email  			= res.email;
					name  				= res.name;
					birthday  			= res.birthday;
					tessera  			= res.tessera;
					amministratore  	= res.amministratore;
					
					if (autoid=="0") {
						// non ho una sessione valida, devo eseguire il login remoto;
						$('#clienteBtn').css('display','none');
						$('#vipBtn').css('display','none');
						$('#loginBtn').css('display','block');
						//$('#monitorTxt').append('<br>Non hai eseguito l\'accesso: fai il login.');	
											
					} else  {
						// sono autenticato in remoto, posso memorizzare il locale i miei dati;
						setIt(autoid, email, name, birthday, tessera, amministratore);
						$('#clienteBtn').html(name);
						$('#vipBtn').html('<img src="http://chart.apis.google.com/chart?cht=qr&chs=250x250&chof=png&chl=vipcard.php%3FID%3D' + autoid + '-' + tessera + '&choe=UTF-8">');
						$('#loginBtn').css('display','none');
						$('#clienteBtn').css('display','block');
						$('#vipBtn').css('display','block');
						
						if (amministratore=="1") {
							$('#scannerBtn').css('display','block');
						} else {
							$('#scannerBtn').css('display','none');
						}
						
						//$('#monitorTxt').append('<br><br>Ciao ' + name);	
						
					}
					
					
				 
				 
				});
				
			}
			
			
            function nullIt() {
                
				
				localStorage.setItem("profilo_key", null);
				autoid 			= "0";
				email  			= "";
				name  			= "";
				birthday  		= "";
				tessera  		= "";
				amministratore  = "";
				 //$('#monitorTxt').html("Dati cancellati in locale.");
				
				$.getJSON(appPath + 'logout.php?callback=?','app=' + appName,function(res){
					//$('#monitorTxt').append("Dati cancellati in remoto.");
				});
				
				$('#clienteBtn').css('display','none');
				$('#vipBtn').css('display','none');
				$('#loginBtn').css('display','block');
				$('#scannerBtn').css('display','none');
                 
				             
            }
            function getIt() {
                var stringifiedObject = localStorage.getItem("profilo_key");
                var reconstitutedObject = JSON.parse(stringifiedObject);
                if (reconstitutedObject) {
					
					//alert(reconstitutedObject.email);
					autoid 			= reconstitutedObject.autoid;
					email  			= reconstitutedObject.email;
					name  				= reconstitutedObject.name;
					birthday  			= reconstitutedObject.birthday;
					tessera  			= reconstitutedObject.tessera;
					amministratore  	= reconstitutedObject.amministratore;
					
                    reconstitutedObject.toString = toString;
                    //$('#monitorTxt').html("Dati gi&agrave; in memoria locale."); 
					$('#clienteBtn').html(reconstitutedObject.name);
					$('#vipBtn').html('<img src="http://chart.apis.google.com/chart?cht=qr&chs=250x250&chof=png&chl=vipcard.php%3FID%3D' + reconstitutedObject.autoid + '-' + reconstitutedObject.tessera + '&choe=UTF-8">');
					$('#loginBtn').css('display','none');
					$('#clienteBtn').css('display','block');
					$('#vipBtn').css('display','block');
					
					if (amministratore=="1") {
						$('#scannerBtn').css('display','block');
					} else {
						$('#scannerBtn').css('display','none');
					}
					
                }
                else {
                    //$('#monitorTxt').html("Nessun dato presente in locale, controllo in remoto.");
					$('#clienteBtn').css('display','none');
					$('#vipBtn').css('display','none');
					$('#loginBtn').css('display','none');
					controllaLogin();
                }
            }
			
			
			function ciclo() {
				contatore++;
				$('#footer p').html(contatore);
				if(autoid=="0") {
					getIt();
				} else {
					window.clearInterval(intervallo);					
				}				
			}
			
			
			function loginBtn() {
				intervallo = window.setInterval("ciclo()", 1000);
				raggiungi(appPath + 'loginFB.php');
			}
			/*
			document.addEventListener("deviceready", onDeviceReady, false);
			// once the device ready event fires, you can safely do your thing! -jm
			function onDeviceReady() {
				
				getIt();
			}
			*/
			
			$(document).ready(function () {
				
				//controllo se esistono i dati in locale, altrimenti li prelevo dalla sessione remota (se non ci sono nemmeno l√¨ re-indirizzo verso la pagina di login);
				getIt();
				
				//intervallo = window.setInterval("ciclo()", 1000);
			});
			
    	</script>
</head>
<body>
<div id="header">
	<div class="logo"><img src="img/logo.png" style="height:80px;width:100px;border:none;"></div>
</div>

<div class="content">
    <div id="loginBtn" class="button" onClick="loginBtn();" style="display:none;">
        LOGIN
    </div>
    <div id="clienteBtn" class="button" onClick="dettaglioCliente();" style="display:none;">
        ***
    </div>
</div>

<div class="content">
	<div id="vipBtn" class="button btnQR" onClick="mostraVIPCard();" style="display:none;">
		***
    </div>
</div>

<div class="content">
	<div id ="scannerBtn" class="button" onClick="raggiungi('scanner.html');" style="display:none;">
    	LETTORE QR
    </div>
</div>


<div class="content">
	<div class="button" onClick="nullIt();">
    	LOGOUT
    </div>
</div>



<div id="footer" style="">
	<p style="text-align:center;color:#fff;font-family: 'Ropa Sans', sans-serif;">info</p>
</div>
<script type="text/javascript" src="cordova.js"></script>
</body>
</html>